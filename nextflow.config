// default configs for all pipelines; overrides per-pipeline configs
params.workflow_label = "NGS580"

manifest {
    author = 'Stephen Kelly'
    homePage = 'https://github.com/NYU-Molecular-Pathology/NGS580-nf'
    description = 'NGS580 target exome analysis for 580 gene panel'
    mainScript = 'main.nf'
}

// NEXTFLOW SETTINGS
report {
    enabled = true
    file = "nextflow.html"
}

trace {
    enabled = true
    fields = "task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes"
    file = "trace.txt"
    raw = true
}

timeline {
    enabled = true
    file = "timeline.html"
}

username = System.getProperty("user.name")
params.username = username
params.email_host = "nyumc.org"
params.email_from = "${username}@${params.email_host}"
params.email_to = "${username}@${params.email_host}"
params.pipeline_email = true

notification {
    enabled = params.pipeline_email
    to = "${params.email_to}"
    from = "${params.email_from}"
}

params.scratchDir = null

// params.ANNOVAR_DIR = "annovar"
// params.ANNOVAR_DB_DIR = "annovar_db"
// params.ANNOVAR_PROTOCOL = "refGene,1000g2015aug_all,clinvar_20170905,intervar_20170202,dbnsfp33a,esp6500siv2_all,kaviar_20150923,gnomad_exome,gnomad_genome,avsnp150,fathmm,eigen"
// params.ANNOVAR_OPERATION ="g,f,f,f,f,f,f,f,f,f,f,f"
params.ANNOVAR_BUILD_VERSION ="hg19"
params.ANNOVAR_dbSNP_COLNAME = "dbSNP_147"

params.ANNOVAR_PROTOCOL = "refGene,clinvar_20170905,cosmic70,1000g2015aug_all,dbnsfp33a,avsnp150,exac03,snp138"
params.ANNOVAR_OPERATION ="g,f,f,f,f,f,f,f"




env {
    ANNOVAR_PROTOCOL = params.ANNOVAR_PROTOCOL
    ANNOVAR_OPERATION = params.ANNOVAR_OPERATION
    ANNOVAR_BUILD_VERSION = params.ANNOVAR_BUILD_VERSION
    ANNOVAR_dbSNP_COLNAME = params.ANNOVAR_dbSNP_COLNAME
}


// PROCESSES VALUES
params.beforeScript_str = 'printf "USER:\${USER:-none} JOB_ID:\${JOB_ID:-none} JOB_NAME:\${JOB_NAME:-none} HOSTNAME:\${HOSTNAME:-none} PWD:\$PWD\n"; TIMESTART=\$(date +%s)'
params.afterScript_str = 'printf "elapsed time: %s\n" \$((\$(date +%s) - \${TIMESTART:-0}))'

process.beforeScript = "${params.beforeScript_str}"
process.afterScript = "${params.afterScript_str}"

params.trimmomatic_path_cmd = 'export PATH="/ifs/data/sequence/results/external/NYU/snuderllab/bin/trimmomatic/0.33:\${PATH}"'
params.sambamba_path_cmd = 'export PATH="/ifs/data/sequence/results/external/NYU/snuderllab/bin/sambamba:\${PATH}"'
params.gatk_path_cmd = 'export PATH="/ifs/data/molecpathlab/bin/GenomeAnalysisTK-3.8-0:\${PATH}"'
params.lofreq_path_cmd = 'export PATH="/ifs/data/sequence/results/external/NYU/snuderllab/bin/lofreq/lofreq_star-2.1.2/bin:\${PATH}"'
params.msisensor_path_cmd = 'export PATH="/ifs/data/molecpathlab/bin/msisensor:\${PATH}"'
params.delly_path_cmd = 'export PATH="/ifs/home/kellys04/software/delly/src:/ifs/home/kellys04/software/delly/src/bcftools:\${PATH}"'


params.msisensor_disable = true

params.cpus_num_big = 16
params.cpus_num_mid = 8
params.cpus_num_small = 4

// Singularity containers; on NYU Big Purple HPC
params.containerDir = "/gpfs/data/molecpathlab/containers/NGS580-nf"
params.ref_dir = "ref"

profiles {
    phoenix { // for running on NYU phoenix HPC cluster
        process.executor = 'sge'
        process.queue = 'all.q'
        process.clusterOptions = '-cwd'
        process.errorStrategy = 'retry'
        process.maxRetries = 3
        executor.queueSize = 50
        executor$sge.pollInterval = '1min'
        executor$sge.queueStatInterval = '2min'

        params.ref_dir = "/ifs/data/sequence/results/external/NYU/snuderllab/ref"

        env.ANNOVAR_DIR = "/ifs/data/molecpathlab/bin/annovar"
        params.ANNOVAR_DB_DIR = "/ifs/data/molecpathlab/bin/annovar/db/hg19"
        env.ANNOVAR_DB_DIR = params.ANNOVAR_DB_DIR
        env.ANNOVAR_PROTOCOL = params.ANNOVAR_PROTOCOL
        env.ANNOVAR_BUILD_VERSION = params.ANNOVAR_BUILD_VERSION
        env.ANNOVAR_OPERATION = params.ANNOVAR_OPERATION

        params.multiqc_setup_cmd = "module unload python ; unset PYTHONPATH ; unset PYTHONHOME ; source /ifs/data/molecpathlab/bin/conda3/bin/activate ; export LANG=en_US.utf8 ; export LC_ALL=en_US.utf8 "

        process.$fastqc_trim.module = "fastqc/0.11.7"
        process.$bwa_mem.module = 'bwa/0.7.17'
        process.$sambamba_dedup.module = "samtools/1.3"
        process.$bam_ra_rc_gatk.module = 'samtools/1.3:java/1.8'
        process.$pad_bed.module = 'bedtools/2.26.0'
        process.$lofreq.module = 'samtools/1.3:java/1.8'
        process.$gatk_hc.module = 'samtools/1.3:java/1.8'
        process.$msisensor.module = 'samtools/1.3'
        process.$mutect2.module = 'samtools/1.3:java/1.8'
        process.$custom_analysis_report.module = 'pandoc/1.13.1'
        process.$custom_sample_report.module = 'pandoc/1.13.1'
        process.$eval_sample_vcf.module = 'samtools/1.3:java/1.8'
        process.$eval_pair_vcf.module = 'samtools/1.3:java/1.8'
        process.$qc_target_reads_gatk_genome.module = 'java/1.8'
        process.$qc_target_reads_gatk_pad500.module = 'java/1.8'
        process.$qc_target_reads_gatk_pad100.module = 'java/1.8'
        process.$qc_target_reads_gatk_bed.module = 'java/1.8'


        process.$trimmomatic.beforeScript = "${params.beforeScript_str} ; ${params.trimmomatic_path_cmd}"
        process.$sambamba_view_sort.beforeScript = "${params.beforeScript_str} ; ${params.sambamba_path_cmd}"
        process.$sambamba_flagstat.beforeScript = "${params.beforeScript_str} ; ${params.sambamba_path_cmd}"
        process.$sambamba_dedup.beforeScript = "${params.beforeScript_str} ; ${params.sambamba_path_cmd}"
        process.$sambamba_dedup_flagstat.beforeScript = "${params.beforeScript_str} ; ${params.sambamba_path_cmd}"

        process.$qc_target_reads_gatk_genome.beforeScript = "${params.beforeScript_str} ; ${params.gatk_path_cmd}"
        process.$qc_target_reads_gatk_pad500.beforeScript = "${params.beforeScript_str} ; ${params.gatk_path_cmd}"
        process.$qc_target_reads_gatk_pad100.beforeScript = "${params.beforeScript_str} ; ${params.gatk_path_cmd}"
        process.$qc_target_reads_gatk_bed.beforeScript = "${params.beforeScript_str} ; ${params.gatk_path_cmd}"
        process.$bam_ra_rc_gatk.beforeScript = "${params.beforeScript_str} ; ${params.gatk_path_cmd}"
        process.$mutect2.beforeScript = "${params.beforeScript_str} ; ${params.gatk_path_cmd}"
        process.$gatk_hc.beforeScript = "${params.beforeScript_str} ; ${params.gatk_path_cmd}"
        process.$lofreq.beforeScript = "${params.beforeScript_str} ; ${params.gatk_path_cmd} ; ${params.lofreq_path_cmd}"
        process.$eval_sample_vcf.beforeScript = "${params.beforeScript_str} ; ${params.gatk_path_cmd}"
        process.$eval_pair_vcf.beforeScript = "${params.beforeScript_str} ; ${params.gatk_path_cmd}"


        process.$delly2.beforeScript = "${params.beforeScript_str} ; ${params.delly_path_cmd}"
        process.$msisensor.beforeScript = "${params.beforeScript_str} ; ${params.msisensor_path_cmd}"
        process.$multiqc.beforeScript = "${params.beforeScript_str} ; ${params.multiqc_setup_cmd}"
        process.$annotate.beforeScript = "${params.beforeScript_str} ; export PATH=/ifs/data/molecpathlab/bin/annovar:\$PATH"
        process.$annotate_pairs.beforeScript = "${params.beforeScript_str} ; export PATH=/ifs/data/molecpathlab/bin/annovar:\$PATH"


        process.$trimmomatic.clusterOptions = "-pe threaded 1-${params.cpus_num_mid} -l mem_free=40G -l mem_token=5G"
        process.$bwa_mem.clusterOptions = "-pe threaded ${params.cpus_num_small}-${params.cpus_num_big} -l mem_free=40G -l mem_token=4G"
        process.$sambamba_view_sort.clusterOptions = "-pe threaded 1-${params.cpus_num_mid} -l mem_free=40G -l mem_token=4G"
        process.$sambamba_dedup.clusterOptions = "-pe threaded 1-${params.cpus_num_mid} -l mem_free=40G -l mem_token=4G"
        process.$qc_target_reads_gatk_genome.clusterOptions = "-pe threaded ${params.cpus_num_small}-${params.cpus_num_big} -l mem_free=40G -l mem_token=5G -hard"
        process.$qc_target_reads_gatk_pad500.clusterOptions = "-l mem_free=40G -l mem_token=5G -hard"
        process.$qc_target_reads_gatk_pad100.clusterOptions = "-l mem_free=40G -l mem_token=5G -hard"
        process.$qc_target_reads_gatk_bed.clusterOptions = "-l mem_free=40G -l mem_token=5G -hard"
        process.$bam_ra_rc_gatk.clusterOptions = "-pe threaded ${params.cpus_num_small}-${params.cpus_num_big} -l mem_free=40G -l mem_token=4G -hard"
        process.$lofreq.clusterOptions = "-pe threaded ${params.cpus_num_small}-${params.cpus_num_big} -l mem_free=40G -l mem_token=4G -hard"
        process.$gatk_hc.clusterOptions = "-pe threaded ${params.cpus_num_small}-${params.cpus_num_big} -l mem_free=40G -l mem_token=4G -hard"
        process.$msisensor.clusterOptions = "-pe threaded 1-${params.cpus_num_mid} -l mem_free=40G -l mem_token=5G"
        process.$mutect2.clusterOptions = "-l mem_free=40G -l mem_token=40G -hard"
        process.$eval_sample_vcf.clusterOptions = "-l mem_free=40G -l mem_token=40G -hard"
        process.$eval_pair_vcf.clusterOptions = "-l mem_free=60G -l mem_token=60G -hard"
    }

    headnode { // phoenix2 head node for Singularity testing
        process.executor = 'local'
        executor.queueSize = 2
        singularity.enabled = true
        // process.module = "singularity/2.4.2"

        params.ref_dir = "/ifs/data/sequence/results/external/NYU/snuderllab/ref"

        env.ANNOVAR_DIR = "/ifs/data/molecpathlab/bin/annovar"
        env.ANNOVAR_DB_DIR = "/ifs/data/molecpathlab/bin/annovar/db/hg19"
        env.ANNOVAR_PROTOCOL = params.ANNOVAR_PROTOCOL
        env.ANNOVAR_BUILD_VERSION = params.ANNOVAR_BUILD_VERSION
        env.ANNOVAR_OPERATION = params.ANNOVAR_OPERATION

        params.container_dir = "/ifs/data/molecpathlab/containers/Singularity"

        params.bedtools_container = "${params.container_dir}/bedtools-2.26.0/stevekm_ngs580-nf_bedtools-2.26.0-2018-03-16-89bb629bf549.img"
        params.bwa_container = "${params.container_dir}/bwa-0.7.17/stevekm_ngs580-nf_bwa-0.7.17-2018-03-16-3ed0de18d226.img"
        params.fastqc_container = "${params.container_dir}/fastqc-0.11.7/stevekm_ngs580-nf_fastqc-0.11.7-2018-03-16-060400f59bab.img"
        params.msisensor_container = "${params.container_dir}/msisensor-0.2/stevekm_ngs580-nf_msisensor-0.2-2018-03-16-6b8b985b4e9c.img"
        params.multiqc_container = "${params.container_dir}/multiqc-1.4/stevekm_ngs580-nf_multiqc-1.4-2018-03-16-7de0fa606cbf.img"
        params.sambamba_container = "${params.container_dir}/sambamba-0.6.6/stevekm_ngs580-nf_sambamba-0.6.6-2018-03-16-819302d7452d.img"
        params.trimmomatic_container = "${params.container_dir}/trimmomatic-0.36/stevekm_ngs580-nf_trimmomatic-0.36-2018-03-15-d75579d18b70.img"
        params.variant_calling_container = "${params.container_dir}/variant-calling-0.0.2/stevekm_ngs580-nf_variant-calling-0.0.2-2018-03-16-0cbe57c9c8da.img"
        params.R_container = "${params.container_dir}/R-3.3.2/stevekm_ngs580-nf_R-3.3.2-2018-03-16-b3bacf0d733a.img"

        process.$sambamba_view_sort.container = "${params.sambamba_container}"
        process.$sambamba_flagstat.container = "${params.sambamba_container}"
        process.$sambamba_dedup.container = "${params.sambamba_container}"
        process.$sambamba_dedup_flagstat.container = "${params.sambamba_container}"
        process.$qc_target_reads_gatk_genome.container = "${params.variant_calling_container}"
        process.$qc_target_reads_gatk_pad500.container = "${params.variant_calling_container}"
        process.$qc_target_reads_gatk_pad100.container = "${params.variant_calling_container}"
        process.$qc_target_reads_gatk_bed.container = "${params.variant_calling_container}"
        process.$bam_ra_rc_gatk.container = "${params.variant_calling_container}"
        process.$pad_bed.container = "${params.bedtools_container}"
        process.$lofreq.container = "${params.variant_calling_container}"
        process.$gatk_hc.container = "${params.variant_calling_container}"
        process.$deconstructSigs_signatures.container = "${params.R_container}"
        process.$vaf_distribution_plot.container = "${params.R_container}"
        process.$msisensor.container = "${params.msisensor_container}"
        process.$mutect2.container = "${params.variant_calling_container}"
        process.$multiqc.container = "${params.multiqc_container}"
        process.$eval_sample_vcf.container = "${params.variant_calling_container}"
        process.$eval_pair_vcf.container = "${params.variant_calling_container}"
    }

    local {
        // running on local desktop with Docker;
        // tested with 6CPU, 24GB RAM Docker configuration, make sure to update Docker settings for this
        process.executor = 'local'
        executor.queueSize = 1 // memory issues running parallel jobs locally
        docker.enabled = true
        params.docker_threads = 6

        params.ANNOVAR_DIR = new File("annovar").getCanonicalPath()
        params.ANNOVAR_DB_DIR = new File("annovar_db").getCanonicalPath()

        params.ref_dir = "ref"

        env.ANNOVAR_DIR = params.ANNOVAR_DIR
        env.ANNOVAR_DB_DIR = params.ANNOVAR_DB_DIR
        env.ANNOVAR_PROTOCOL = params.ANNOVAR_PROTOCOL
        env.ANNOVAR_BUILD_VERSION = params.ANNOVAR_BUILD_VERSION
        env.ANNOVAR_OPERATION = params.ANNOVAR_OPERATION

        params.bedtools_container = "stevekm/ngs580-nf:bedtools-2.26.0"
        params.bwa_container = "stevekm/ngs580-nf:bwa-0.7.17"
        params.fastqc_container = "stevekm/ngs580-nf:fastqc-0.11.7"
        params.msisensor_container = "stevekm/ngs580-nf:msisensor-0.2"
        params.multiqc_container = "stevekm/ngs580-nf:multiqc-1.4"
        params.sambamba_container = "stevekm/ngs580-nf:sambamba-0.6.6"
        params.trimmomatic_container = "stevekm/ngs580-nf:trimmomatic-0.36"
        params.variant_calling_container = "stevekm/ngs580-nf:variant-calling-0.0.2"
        params.R_container = "stevekm/ngs580-nf:R-3.3.2"
        params.delly2_container = "stevekm/ngs580-nf:delly2-0.7.7"
        params.annovar_container = "stevekm/ngs580-nf:annovar-150617"
        params.report_container= "stevekm/ngs580-nf:reporting-3.4.3"

        process.$trimmomatic.container = "${params.trimmomatic_container}"
        process.$fastqc_trim.container = "${params.fastqc_container}"
        process.$bwa_mem.container = "${params.bwa_container}"

        process.$sambamba_view_sort.container = "${params.sambamba_container}"
        process.$sambamba_flagstat.container = "${params.sambamba_container}"
        process.$sambamba_dedup.container = "${params.sambamba_container}"
        process.$sambamba_dedup_flagstat.container = "${params.sambamba_container}"
        process.$qc_target_reads_gatk_genome.container = "${params.variant_calling_container}"
        process.$qc_target_reads_gatk_pad500.container = "${params.variant_calling_container}"
        process.$qc_target_reads_gatk_pad100.container = "${params.variant_calling_container}"
        process.$qc_target_reads_gatk_bed.container = "${params.variant_calling_container}"
        process.$bam_ra_rc_gatk.container = "${params.variant_calling_container}"
        process.$pad_bed.container = "${params.bedtools_container}"
        process.$lofreq.container = "${params.variant_calling_container}"
        process.$gatk_hc.container = "${params.variant_calling_container}"
        process.$deconstructSigs_signatures.container = "${params.R_container}"
        process.$vaf_distribution_plot.container = "${params.R_container}"
        process.$msisensor.container = "${params.msisensor_container}"
        process.$mutect2.container = "${params.variant_calling_container}"
        process.$multiqc.container = "${params.multiqc_container}"
        process.$eval_sample_vcf.container = "${params.variant_calling_container}"
        process.$eval_pair_vcf.container = "${params.variant_calling_container}"
        process.$delly2.container = "${params.delly2_container}"
        process.$annotate.container = "${params.annovar_container}"
        process.$annotate_pairs.container = "${params.annovar_container}"
        process.$custom_analysis_report.container = "${params.report_container}"
        process.$custom_sample_report.container = "${params.report_container}"

        process.$trimmomatic.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"
        process.$bwa_mem.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"
        process.$sambamba_view_sort.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"
        process.$sambamba_dedup.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"
        process.$qc_target_reads_gatk_genome.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"
        process.$qc_target_reads_gatk_pad500.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"
        process.$qc_target_reads_gatk_pad100.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"
        process.$qc_target_reads_gatk_bed.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"
        process.$bam_ra_rc_gatk.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"
        process.$lofreq.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"
        process.$gatk_hc.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"
        process.$msisensor.beforeScript = "${params.beforeScript_str} ; export NTHREADS=${params.docker_threads}"

    }

    power { // profile for Power8 / Power9 execution
        process.executor = 'local'
        // process.executor = 'lsf'
        // process.queue = 'all.q'
        // process.clusterOptions = '-cwd'
        executor.queueSize = 5

        // env.ANNOVAR_DIR = "/home/kellys04/projects/NGS580-nf/annovar"
        // env.ANNOVAR_DB_DIR = "/home/kellys04/projects/NGS580-nf/annovar_db"
        params.ANNOVAR_DIR = new File("bin/annovar").getCanonicalPath()
        params.ANNOVAR_DB_DIR = new File("annovar_db").getCanonicalPath()

        env.ANNOVAR_DIR = params.ANNOVAR_DIR
        env.ANNOVAR_DB_DIR = params.ANNOVAR_DB_DIR
        env.ANNOVAR_PROTOCOL = params.ANNOVAR_PROTOCOL
        env.ANNOVAR_BUILD_VERSION = params.ANNOVAR_BUILD_VERSION
        env.ANNOVAR_OPERATION = params.ANNOVAR_OPERATION

        params.ref_dir = "ref"

        // CPU allocations
        process.$trimmomatic.cpus = params.cpus_num_mid
        process.$bwa_mem.cpus = params.cpus_num_mid
        process.$sambamba_view_sort.cpus = params.cpus_num_mid
        process.$sambamba_dedup.cpus = params.cpus_num_mid
        process.$qc_target_reads_gatk_genome.cpus = params.cpus_num_mid
        process.$qc_target_reads_gatk_pad500.cpus = params.cpus_num_mid
        process.$qc_target_reads_gatk_pad100.cpus = params.cpus_num_mid
        process.$qc_target_reads_gatk_bed.cpus = params.cpus_num_mid
        process.$bam_ra_rc_gatk.cpus = params.cpus_num_mid
        process.$lofreq.cpus = params.cpus_num_mid
        process.$gatk_hc.cpus = params.cpus_num_mid
        process.$msisensor.cpus = params.cpus_num_mid
        // process.$mutect2.clusterOptions = '-l mem_free=150G -hard'

        // beforeScript setup per process
        // Miniconda configs
        // full Biobuilds channel env
        params.miniconda_env_str = "source /shared/miniconda2/bin/activate /shared/biobuilds-2017.11"

        // custom per-tool Miniconda install
        params.custom_miniconda = "source /shared/miniconda3/bin/activate"
        params.bedtools_env = "${params.custom_miniconda} bedtools-2.26.0"
        params.bwa_env = "${params.custom_miniconda} bwa-0.7.17"
        params.fastqc_env = "${params.custom_miniconda} fastqc-0.11.5"
        // params.msisensor_env = "${params.custom_miniconda} ..... "
        // params.multiqc_env = "${params.custom_miniconda} ....."
        params.sambamba_env = "${params.custom_miniconda} sambamba-0.6.6"
        params.trimmomatic_env = "${params.custom_miniconda} trimmomatic-0.36"
        params.variant_calling_env = "${params.custom_miniconda} variant-calling-0.0.2"
        // params.R_env = "${params.custom_miniconda} ....."
        params.delly2_env = "${params.custom_miniconda} delly2-0.7.6"

        // gatk.sh location for version 3.8-0-ge9d806836
        params.gatk_path_cmd = 'export PATH="/shared/GATK-P9:\${PATH}"'

        // trimmomatic.sh location
        params.trimmomatic_path_cmd = 'export PATH="/shared/biobuilds-2017.11/libexec/trimmomatic-0.36:\${PATH}"'


        process.beforeScript = "${params.beforeScript_str} ; ${params.miniconda_env_str}"


        process.$trimmomatic.beforeScript = "${process.beforeScript} ; ${params.trimmomatic_path_cmd} ; export NTHREADS=${process.$trimmomatic.cpus} ; ${params.miniconda_env_str}"
        process.$bwa_mem.beforeScript = "${process.beforeScript} ; export NTHREADS=${process.$bwa_mem.cpus}"
        process.$qc_target_reads_gatk_genome.beforeScript = "${process.beforeScript} ; ${params.gatk_path_cmd} ; export NTHREADS=${process.$qc_target_reads_gatk_genome.cpus}"
        process.$qc_target_reads_gatk_pad500.beforeScript = "${process.beforeScript} ; ${params.gatk_path_cmd} ; export NTHREADS=${process.$qc_target_reads_gatk_pad500.cpus}"
        process.$qc_target_reads_gatk_pad100.beforeScript = "${process.beforeScript} ; ${params.gatk_path_cmd} ; export NTHREADS=${process.$qc_target_reads_gatk_pad100.cpus}"
        process.$qc_target_reads_gatk_bed.beforeScript = "${process.beforeScript} ; ${params.gatk_path_cmd} ; export NTHREADS=${process.$qc_target_reads_gatk_bed.cpus}"
        process.$bam_ra_rc_gatk.beforeScript = "${process.beforeScript} ; ${params.gatk_path_cmd} ; export NTHREADS=${process.$bam_ra_rc_gatk.cpus}"
        process.$gatk_hc.beforeScript = "${process.beforeScript} ; ${params.gatk_path_cmd} ; export NTHREADS=${process.$gatk_hc.cpus}"
        process.$lofreq.beforeScript = "${process.beforeScript} ; ${params.gatk_path_cmd} ; ${params.lofreq_path_cmd} ; export NTHREADS=${process.$lofreq.cpus}"
        process.$sambamba_view_sort.beforeScript = "${process.beforeScript} ; export NTHREADS=${process.$sambamba_view_sort.cpus}"

        process.$mutect2.beforeScript = "${process.beforeScript} ; ${params.gatk_path_cmd}"

        process.$eval_sample_vcf.beforeScript = "${process.beforeScript} ; ${params.gatk_path_cmd}"
        process.$eval_pair_vcf.beforeScript = "${process.beforeScript} ; ${params.gatk_path_cmd}"
    }

    bigPurple { // NYU Big Purple HPC cluster
        // reference locations
        params.ref_dir = "/gpfs/data/molecpathlab/ref"
        params.ANNOVAR_DB_DIR = "/gpfs/data/molecpathlab/ref/annovar/db"

        // SLURM exector config
        process.executor = 'slurm'
        params.queue = "cpu_short" // allow to set queue from CLI
        process.queue = "${params.queue}"
        process.clusterOptions = '--ntasks-per-node=1 --export=NONE --export=NTHREADS'

        // Singularity config
        process.module = "singularity/2.5.2"
        singularity.enabled = true
        singularity.autoMounts = true
        singularity.envWhitelist = "NTHREADS"

        // job config value
        params.cpus_num_big = 16
        params.cpus_num_mid = 8
        params.cpus_num_small = 4
        // try to prevent error: module: command not found by sourcing module config
        params.beforeScript_str = '. /etc/profile.d/modules.sh; printf "USER:\${USER:-none} SLURM_JOB_ID:\${SLURM_JOB_ID:-none} SLURM_JOB_NAME:\${SLURM_JOB_NAME:-none} HOSTNAME:\${HOSTNAME:-none} PWD:\$PWD NTHREADS:\${NTHREADS:-none}\n"; TIMESTART=\$(date +%s)'

        // global process config
        process.beforeScript = "${params.beforeScript_str}"
        process.errorStrategy = "retry" // re-submit failed processes; try to mitigate SLURM and 'module' command not found errors, etc
        process.maxRetries = 1 // retry a failed process up to 1 times as per ^^
        process.cpus = 2 // 2 CPUs default due to cgroups on Big Purple limiting access to SLURM allocated cores only
        // also add 1 greater CPU allocation than designated in tasks to allow for process overhead threads
        if ( params.scratchDir != null ) process.scratch = "${params.scratchDir}"

        process {
            withName: trimmomatic {
                container = "${params.containerDir}/trimmomatic-0.36.simg"
                cpus = params.cpus_num_mid + 1
                beforeScript = "export NTHREADS=${params.cpus_num_mid}; ${process.beforeScript}"
            }
            withName: fastqc {
                container = "${params.containerDir}/fastqc-0.11.7.simg"
            }
            withName: bwa_mem {
                container = "${params.containerDir}/bwa-0.7.17.simg"
                cpus = params.cpus_num_mid + 1
                beforeScript = "export NTHREADS=${params.cpus_num_mid}; ${process.beforeScript}"
            }
            withName: sambamba_view_sort {
                container = "${params.containerDir}/sambamba-0.6.6.simg"
                cpus = params.cpus_num_mid + 1
                beforeScript = "export NTHREADS=${params.cpus_num_mid}; ${process.beforeScript}"
            }
            withName: sambamba_dedup {
                container = "${params.containerDir}/sambamba-0.6.6.simg"
                cpus = params.cpus_num_mid + 1
                beforeScript = "export NTHREADS=${params.cpus_num_mid}; ${process.beforeScript}"
            }
            withName: samtools_flagstat {
                container = "${params.containerDir}/samtools-1.7.simg"
            }
            withName: samtools_dedup_flagstat {
                container = "${params.containerDir}/samtools-1.7.simg"
            }
            withName: samtools_flagstat_table {
                container = "${params.containerDir}/R-3.4.3.simg"
            }
            withName: sambamba_dedup_log_table {
                container = "${params.containerDir}/R-3.4.3.simg"
            }
            withName: samtools_dedup_flagstat_table {
                container = "${params.containerDir}/R-3.4.3.simg"
            }
            withName: gatk_RealignerTargetCreator {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                cpus = params.cpus_num_mid + 1
                beforeScript = "export NTHREADS=${params.cpus_num_mid}; ${process.beforeScript}"
            }
            withName: gatk_IndelRealigner {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
            }
            withName: gatk_BaseRecalibrator {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                cpus = params.cpus_num_mid + 1
                beforeScript = "export NTHREADS=${params.cpus_num_mid}; ${process.beforeScript}"
            }
            withName: gatk_BaseRecalibratorBQSR {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                cpus = params.cpus_num_mid + 1
                beforeScript = "export NTHREADS=${params.cpus_num_mid}; ${process.beforeScript}"
            }
            withName: gatk_AnalyzeCovariates {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
            }
            withName: gatk_PrintReads {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                cpus = params.cpus_num_mid + 1
                beforeScript = "export NTHREADS=${params.cpus_num_mid}; ${process.beforeScript}"
            }
            withName: eval_pair_vcf {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
            }
            withName: sambamba_view_sort {
                container = "${params.containerDir}/sambamba-0.6.8.simg"
            }
            withName: qc_target_reads_gatk_pad100 {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                clusterOptions = '--mem=20000' // 20GB free on node
            }
            withName: qc_target_reads_gatk_pad500 {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                clusterOptions = '--mem=20000' // 20GB free on node
            }
            withName: qc_target_reads_gatk_bed {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                clusterOptions = '--mem=20000' // 20GB free on node
            }
            withName: qc_target_reads_gatk_genome {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                clusterOptions = '--mem=20000' // 20GB free on node
            }
            withName: lofreq {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                cpus = params.cpus_num_mid + 1
                // clusterOptions = '--mem=40000' // 40GB free on node
                beforeScript = "export NTHREADS=${params.cpus_num_mid}; ${process.beforeScript}"
            }
            withName: gatk_hc {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                cpus = params.cpus_num_mid + 1
                // clusterOptions = '--mem=40000' // 40GB free on node
                beforeScript = "export NTHREADS=${params.cpus_num_mid}; ${process.beforeScript}"
            }
            withName: mutect2 {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                // clusterOptions = '--mem=40000' // 40GB free on node
            }
            withName: eval_sample_vcf {
                container = "${params.containerDir}/variant-calling-0.0.2.simg"
                clusterOptions = '--mem=16000' // 16GB free on node
            }
            withName: delly2 {
                container = "${params.containerDir}/delly2-0.7.7.simg"
            }
            withName: update_interval_tables {
                container = "${params.containerDir}/R-3.4.3.simg"
            }
            withName: update_coverage_tables {
                container = "${params.containerDir}/R-3.4.3.simg"
            }
            withName: annotate {
                container = "${params.containerDir}/annovar-150617.simg"
            }
            withName: deconstructSigs_signatures {
                container = "${params.containerDir}/deconstructSigs-1.8.0.simg"
            }
            withName: custom_sample_report {
                container = "${params.containerDir}/reporting-3.4.3.simg"
            }
            withName: custom_analysis_report {
                container = "${params.containerDir}/reporting-3.4.3.simg"
            }
        }
    }

    ref { // for setting up reference data locally in the current directory
        params.ref_dir = "ref"
    }

    annovar_db { // for setting up reference data locally in the current directory
        params.ref_dir = "ref"
        docker.enabled = true
        executor.queueSize = 2
        process.$make_ANNOVAR_db.container = "stevekm/ngs580-nf:annovar-150617"
        params.ANNOVAR_DB_DIR = "annovar_db"
    }

    annovar_db_conda { // for setting up reference data locally in the current directory
        params.ref_dir = "ref"
        docker.enabled = true
        executor.queueSize = 2

        params.miniconda_env_str = "source /shared/miniconda3/bin/activate"
        params.make_ANNOVAR_db_env = "annovar-150617"
        process.$make_ANNOVAR_db.beforeScript = "${params.miniconda_env_str} ${params.make_ANNOVAR_db_env} ;"
        params.ANNOVAR_DB_DIR = "annovar_db"
    }

    annovar_db_bigpurple { // NYU Big Purple HPC
        params.ANNOVAR_DB_DIR = "annovar_db"
        process.module = "singularity/2.5.2"
        singularity.enabled = true
        singularity.autoMounts = true
        singularity.runOptions = "-B ${params.ANNOVAR_DB_DIR}"
        process {
            withName: make_ANNOVAR_db {
                container = "${params.containerDir}/annovar-150617.simg"
            }
        }
    }
}

// REFERENCE FILES
params.ref_fa = "${params.ref_dir}/iGenomes/Homo_sapiens/UCSC/hg19/Sequence/WholeGenomeFasta/genome.fa"
params.ref_fa_bwa_dir = "${params.ref_dir}/BWA/hg19"
params.ref_fai = "${params.ref_dir}/iGenomes/Homo_sapiens/UCSC/hg19/Sequence/WholeGenomeFasta/genome.fa.fai"
params.ref_dict = "${params.ref_dir}/iGenomes/Homo_sapiens/UCSC/hg19/Sequence/WholeGenomeFasta/genome.dict"
params.ref_chrom_sizes = "${params.ref_dir}/Illumina/hg19/chrom.sizes"
params.microsatellites = "${params.ref_dir}/msisensor/hg19/microsatellites.list"
params.trimmomatic_contaminant_fa = "${params.ref_dir}/contaminants/trimmomatic.fa"
params.gatk_bundle_dir = "${params.ref_dir}/gatk-bundle"
params.gatk_1000G_phase1_indels_hg19_vcf = "${params.gatk_bundle_dir}/1000G_phase1.indels.hg19.vcf"
params.mills_and_1000G_gold_standard_indels_hg19_vcf = "${params.gatk_bundle_dir}/Mills_and_1000G_gold_standard.indels.hg19.vcf"
params.dbsnp_ref_vcf = "${params.gatk_bundle_dir}/dbsnp_138.hg19.vcf"
params.cosmic_ref_vcf = "${params.ref_dir}/hg19/CosmicCodingMuts_v73.hg19.vcf"
